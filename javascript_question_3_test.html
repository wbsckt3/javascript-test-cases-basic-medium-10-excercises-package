<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue.js Test Cases with Mocha and Chai</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>  
    <link rel="stylesheet" href="https://wbsckt3.github.io/mocha_test_cases_styles_2/style.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuex@3.6.2/dist/vuex.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.4/chai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Bootstrap JS y dependencias -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
    <div id="editor-container">
        <textarea id="code-editor">
shape = {
  radius: 10,
  diameter() {
	return this.radius * 2;
  },
  perimeter(){ return 2 * Math.PI * this.radius }
};
// Casos de prueba:
console.log(shape.diameter());
console.log(shape.perimeter());
        </textarea>
		<img id="logo" src="logo_refactorii.png" alt="Logo Refactorii">
        <button id="run-button">Run</button>
    </div>
    <div id="app-container">
        <div id="app">
		    <h5>Ejercicio 3</h5>
            <p>Se espera en consola: <strong>20, 62.83185307179586</strong></p>
            <div id="modify-message"></div>
			<button id="send-response-button">Enviar respuesta</button>
        </div>
    </div>
    <div id="console-container"><div id="console"></div></div>
    <div id="mocha-container"><div id="mocha"></div></div>
    <script>mocha.setup('bdd');</script>

    <!-- Modal -->
    <div class="modal fade" id="errorMessageModal" tabindex="-1" role="dialog" aria-labelledby="errorMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorMessageModalLabel">Error Message</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="errorMessageModalBody">
                    <!-- Contenido del mensaje de error -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Initialize CodeMirror -->
    <script>
    // Obtener el parámetro `token` de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (token) {
	   // Realiza una solicitud al servicio externo para validar el token
	   fetch(`https://www.refactorii.com/validate-token?token=${token}`)
	   .then(response => response.json())
	   .then(data => {
	      if (data.valid) { console.log(data.valid)
		 test_cases_scenario()    
	      } else { console.log(data.valid)
		 document.body.innerHTML = 'Access denied. Invalid token.';
	      }
	   }).catch(error => {
	      document.body.innerHTML = 'Error validating token.';
	      console.error('Error:', error);
       });
    } else {
       document.body.innerHTML = 'Access denied. No token provided.';
    }
    function test_cases_scenario(){	
        const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            lineNumbers: true,
            mode: 'javascript',
            lineWrapping: true,
            scrollbarStyle: 'null'
        });
        
        var modal_click_message = "Error, Haz click para entender el concepto y modifica la función para imprimir los valores esperados";
        var error_message = 'Hay que tener en cuenta aqui que el valor de diámetro es una función regular o normal, mientras que el valor de perímetro es una función de flecha.'
                            +'Con las funciones de flecha, la palabra clave this se refiere a su ámbito actual, a diferencia de las funciones regulares. Esto significa que cuando '
							+'llamamos "perímetro", no se refiere al objeto en sí mismo, sino a su ámbito circundante (ventana por ejemplo).'
							+'No hay valor radius en ese objeto, que devuelve undefined.';
        var success_message = "Ok! haz modificado la función para mostrar correctamente los mensajes en consola"

        function logToConsole(message, color) {
            const consoleElement = document.getElementById('console');
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            if (color) {
                messageElement.style.color = color;
                messageElement.style.fontWeight = 'bold';
            }
            consoleElement.appendChild(messageElement);
        }

        document.getElementById('run-button').addEventListener('click', function() {
            // Clear previous results
            document.getElementById('console').innerHTML = '';
            document.getElementById('mocha').innerHTML = '';
            mocha.suite.suites = []; // Clear previous test cases

            // Get the user's code from the editor
            const userCode = editor.getValue();

            // Redirect console.log to custom console
            const originalConsoleLog = console.log;
            console.log = function(message) {
                logToConsole(message);
                originalConsoleLog.apply(console, arguments);
            };
			
			// Show "Ejecutando tests..." message and delay tests
			logToConsole('Ejecutando tests...', 'blue');

			setTimeout(() => {

            // Evaluate the user's code
            try {
                new Function(userCode)();

                // Define test cases
                const expect = chai.expect;
                describe('JavaScript Code Tests', function() {
                    it('should execute without errors', function(done) {
                        try {
                            new Function(userCode)();
                            done();
                        } catch (e) {
                            done(e);
                        }
                    });

                   it('should log correct values', function(done) {
						const output = [];
						const originalConsoleLog = console.log;
						console.log = function(message) {
							output.push(message);
							originalConsoleLog.apply(console, arguments);
						};

						// Ensure output is clear before each run
						output.length = 0;

						// Execute user code
						new Function(userCode)();

						// Allow time for setTimeouts to complete
						setTimeout(() => {
							try {
								expect(output[0]).to.equal(20); // Check for the correct output for diameter

								// Check for NaN when perimeter is a arrow function (expected to fail initially)
								if (typeof shape.perimeter === 'function') {
									expect(isNaN(output[1])).to.be.false;
								} else {
									// Check for correct output when perimeter is a regular method
									expect(output[1]).to.equal(62.83185307179586);
								}
								done();
							} catch (err) {
								done(err);
							} finally {
								console.log = originalConsoleLog; // Restore original console.log
							}
						}, 100); // Increase timeout if necessary
					});

                    it('should identify falsy values', function() {
                        expect(false).to.not.be.ok;
                        expect(0).to.not.be.ok;
                        expect('').to.not.be.ok;
                        expect(null).to.not.be.ok;
                        expect(undefined).to.not.be.ok;
                        expect(NaN).to.not.be.ok;
                    });

                    it('should define variables correctly', function() {
                        let testVar = 123;
                        expect(testVar).to.equal(123);
                    });

                    it('should define and call functions correctly', function() {
                        function testFunction() {
                            return 'Hello, World!';
                        }
                        expect(testFunction()).to.equal('Hello, World!');
                    });
                });

                // Run Mocha tests
                mocha.run()
                    .on('test', function(test) {
                        logToConsole('• Running test: ' + test.title);
                    })
                    .on('test end', function(test) {
                        logToConsole('• Test finished: ' + test.title);
                    })
                    .on('pass', function(test) {
                        logToConsole('• Test passed: ' + test.title);
                    })
                    .on('fail', function(test, err) {
						logToConsole('• Test failed: ' + test.title + ' - ' + err.message);
						success_message = modal_click_message;
						const runButton = document.getElementById('run-button');
						runButton.innerText = 'Reintentar';
						runButton.style.backgroundColor = '#ff0000ad';
						runButton.onclick = function() {
							window.location.reload();
						};
						// Función para mostrar el modal con el mensaje de error
						document.getElementById('modify-message').addEventListener('click', function() {
							$('#errorMessageModalBody').html(error_message); // Coloca el contenido del error en el cuerpo del modal
							$('#errorMessageModal').modal('show'); // Muestra el modal
						});
					})
					.on('end', function() {
						logToConsole('• All tests finished!');
						document.getElementById('modify-message').innerText = success_message;
						document.getElementById('modify-message').style.display = 'block';
						document.getElementById('modify-message').style.color = 'black';
						if (success_message === "Ok! haz modificado la función para mostrar correctamente los mensajes en consola") {
							document.getElementById('send-response-button').style.display = 'inline-block';
							document.getElementById('send-response-button').style.background = 'green';
							document.getElementById('send-response-button').style.cursor= 'pointer';
							document.getElementById('send-response-button').style.color= 'white';
						}
					});

            } catch (e) {
                console.error('Error evaluating user code:', e);
                logToConsole('Error: ' + e.message, 'red');
            } finally {
                // Restore original console.log
                console.log = originalConsoleLog;
            }
			
			}, 3000); // 3 seconds delay
			
        });
    }
    </script>
</body>
</html>
