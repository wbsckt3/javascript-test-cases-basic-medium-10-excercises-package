<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue.js Test Cases with Mocha and Chai</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>  
    <link rel="stylesheet" href="https://wbsckt3.github.io/mocha_test_cases_styles_2/style.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuex@3.6.2/dist/vuex.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.4/chai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Bootstrap JS y dependencias -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@4.0.0/build/cjs/index.min.js"></script>
</head>
<body>
    <div id="editor-container">
        <textarea id="code-editor">
const shape = {
  out1() {
	let output = [];
	for (let i = 0; i < 3; i++) {
	  setTimeout(() => {
		console.log(i);
		output.push(i);
	  }, 1);
	}
	return output;
  },
};
// Casos de prueba:
console.log(shape.out1());
        </textarea>
		<img id="logo" src="logo_refactorii.png" alt="Logo Refactorii">
        <button id="run-button">Run</button>
    </div>
    <div id="app-container">
        <div id="app">
		    <h5>Ejercicio 2</h5>
            <p>Modifica la función para mostrar en consola <strong>0,1,2</strong></p>
            <div id="modify-message"></div>
			<button id="send-response-button">Enviar respuesta</button>
        </div>
    </div>
    <div id="console-container"><div id="console"></div></div>
    <div id="mocha-container"><div id="mocha"></div></div>
    <script>mocha.setup('bdd');</script>

    <!-- Modal -->
    <div class="modal fade" id="errorMessageModal" tabindex="-1" role="dialog" aria-labelledby="errorMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorMessageModalLabel">Error Message</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="errorMessageModalBody">
                    <!-- Contenido del mensaje de error -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

 <script>
    // Obtener el parámetro `token` de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (token) {
	    // Realiza una solicitud al servicio externo para validar el token
	    fetch(`https://www.refactorii.com/validate-token?token=${token}`)
	    .then(response => response.json())
	    .then(data => {
	        if (data.valid) {
	            console.log(data.valid);
	             // Decodifica el token para obtener el payload
                     const decodedToken = jwt_decode(token);
         	     const recipeId = decodedToken._id; // Asegúrate de usar el nombre correcto del campo en el payload
                     console.log('Recipe ID:', recipeId);
	            // Llama a la función de prueba
	            test_cases_scenario();
	        } else {
	            console.log(data.valid);
	            document.body.innerHTML = 'Access denied. Invalid token.';
	        }
	    }).catch(error => {
	        document.body.innerHTML = 'Error validating token.';
	        console.error('Error:', error);
	    });
    } else {
	    document.body.innerHTML = 'Access denied. No token provided.';
    }
    function test_cases_scenario(){	
	
	const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
		lineNumbers: true,
        mode: 'javascript',
        lineWrapping: true,
        scrollbarStyle: 'null'
	});

	var modal_click_message = "Error, haz click para entender el concepto y modifica la función para imprimir los valores esperados";
	var error_message = 'Para que la función muestre correctamente 0,1,2 en lugar de 3,3,3, puedes usar let en lugar de var para declarar la variable i. '
			+ 'La palabra clave let tiene un alcance de bloque, lo que significa que cada iteración del bucle tendrá su propia copia de la variable i, '
			+ 'mientras que var tiene un alcance de función, lo que hace que todas las iteraciones compartan la misma variable i.';
	var success_message = "Ok! haz modificado la función para mostrar correctamente los mensajes en consola";

	function logToConsole(message, color) {
		const consoleElement = document.getElementById('console');
		const messageElement = document.createElement('div');
		messageElement.textContent = message;
		if (color) {
			messageElement.style.color = color;
			messageElement.style.fontWeight = 'bold';
		}
		consoleElement.appendChild(messageElement);
	}

	document.getElementById('run-button').addEventListener('click', function() {
		// Clear previous results
		document.getElementById('console').innerHTML = '';
		document.getElementById('mocha').innerHTML = '';
		mocha.suite.suites = []; // Clear previous test cases

		// Get the user's code from the editor
		const userCode = editor.getValue();

		// Redirect console.log to custom console
		const output = [];
		const originalConsoleLog = console.log;
		console.log = function(message) {
			output.push(message);
			logToConsole(message);
		};
		
		// Show "Ejecutando tests..." message and delay tests
		logToConsole('Ejecutando tests...', 'blue');

		setTimeout(() => {

		// Evaluate the user's code and capture output
		try {
			new Function(userCode)();
		

		// Define test cases
		const expect = chai.expect;
		describe('JavaScript Code Tests', function() {
			it('should execute without errors', function(done) {
				try {
					new Function(userCode)();
					done();
				} catch (e) {
					done(e);
				}
			});

			describe('shape.out1()', function() {
			  it('should log correct values', function(done) {
				// Ejecuta la función out1
		
				// Permite tiempo para que los setTimeouts se completen
				setTimeout(() => {
				  try {
					expect(output[0]).to.eql([0, 1, 2]); // Verifica la salida correcta
					done();
				  } catch (err) {
					done(err);
				  }
				}, 100); // Aumenta el tiempo de espera si es necesario
			  });
			});

			/*it('should use let instead of var', function() {
				const letUsed = /let\s+i\s*=/.test(userCode);
				const varUsed = /var\s+i\s*=/.test(userCode);
				expect(letUsed).to.be.true;
				expect(varUsed).to.be.false;
			});*/

			it('should identify falsy values', function() {
				expect(false).to.not.be.ok;
				expect(0).to.not.be.ok;
				expect('').to.not.be.ok;
				expect(null).to.not.be.ok;
				expect(undefined).to.not.be.ok;
				expect(NaN).to.not.be.ok;
			});

			it('should define variables correctly', function() {
				let testVar = 123;
				expect(testVar).to.equal(123);
			});

			it('should define and call functions correctly', function() {
				function testFunction() {
					return 'Hello, World!';
				}
				expect(testFunction()).to.equal('Hello, World!');
			});
		});

		// Run Mocha tests
		mocha.run()
			.on('test', function(test) {
				logToConsole('• Running test: ' + test.title);
			})
			.on('test end', function(test) {
				logToConsole('• Test finished: ' + test.title);
			})
			.on('pass', function(test) {
				logToConsole('• Test passed: ' + test.title);
			})
			.on('fail', function(test, err) {
				logToConsole('• Test failed: ' + test.title + ' - ' + err.message);
				success_message = modal_click_message;
				const runButton = document.getElementById('run-button');
				runButton.innerText = 'Reintentar';
				runButton.style.backgroundColor = '#ff0000ad';
				runButton.onclick = function() {
					window.location.reload();
				};
				// Función para mostrar el modal con el mensaje de error
				document.getElementById('modify-message').addEventListener('click', function() {
					$('#errorMessageModalBody').html(error_message); // Coloca el contenido del error en el cuerpo del modal
					$('#errorMessageModal').modal('show'); // Muestra el modal
				});
			})
			.on('end', function() {
				logToConsole('• All tests finished!');
				document.getElementById('modify-message').innerText = success_message;
				document.getElementById('modify-message').style.display = 'block';
				document.getElementById('modify-message').style.color = 'black';
				if (success_message === "Ok! haz modificado la función para mostrar correctamente los mensajes en consola") {
					document.getElementById('send-response-button').style.display = 'inline-block';
					document.getElementById('send-response-button').style.background = 'green';
					document.getElementById('send-response-button').style.cursor= 'pointer';
					document.getElementById('send-response-button').style.color= 'white';
					guardarResultados(recipeId)
				}
			});
			
			} catch (e) {
			console.error('Error evaluating user code:', e);
			logToConsole('Error: ' + e.message, 'red');
			} finally {
				// Restore original console.log
				console.log = originalConsoleLog;
			}
			
			}, 3000); // 3 seconds delay
	});
    }
    async function guardarResultados(recipeId) {
	    const formData = JSON.parse(localStorage.getItem("formData"));
	    const email = formData ? formData.Email : null;
	    try {
	        const response = await fetch('https://www.refactorii.com/updateOneGoogleSigninUserRecipe', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json'
	            },
	            body: JSON.stringify({ Email: email, recipeCalificadaOk: recipeId })
	        });
	        const data = await response.json();
	        console.log('Server responds:', "Ok");
	    } catch (error) {
	        console.error('Error sending the results to the server:', error);
	    }
    }
</script>
</body>
</html>
