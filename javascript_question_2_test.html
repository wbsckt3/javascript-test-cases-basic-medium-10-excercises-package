<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactorii</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>  
    <link rel="stylesheet" href="https://wbsckt3.github.io/mocha_test_cases_styles_2/style.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuex@3.6.2/dist/vuex.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.4/chai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@4.0.0/build/cjs/index.min.js"></script>
</head>
<body>
    <div id="editor-container">
        <textarea id="code-editor">
const shape = {
  out1() {
    let output = [];
    for (let i = 0; i < 3; i++) {
        console.log(i);
        //output.push(i);
    }
    return output;
  },
};
// Test Cases:
// should log the values 0, 1, and 2 in order
// should return an array with values [0, 1, 2]
console.log(shape.out1());
        </textarea>
	<img id="logo" src="logo_refactorii.png" alt="Logo Refactorii">
        <button id="run-button">Run</button>
    </div>
    <div id="app-container">
        <div id="app">
	    <h5>Excercise 2</h5>
            <p id="modify-message">Refactor the code to obtain the console output of the test cases (click here to expand the concept...)</p>
	    <button id="send-response-button" onClick= "guardarResultados()">Send Response</button>
        </div>
    </div>
    <div id="console-container"><div id="console"></div></div>
    <div id="mocha-container"><div id="mocha"></div></div>
    <script>mocha.setup('bdd');</script>

    <!-- Modal -->
    <div class="modal fade" id="errorMessageModal" tabindex="-1" role="dialog" aria-labelledby="errorMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorMessageModalLabel">Concept</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="errorMessageModalBody">
                    <!-- Contenido del mensaje de error -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

 <script>
    // Obtener el par√°metro `token` de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (token) {
	    // Realiza una solicitud al servicio externo para validar el token
	    fetch(`https://www.refactorii.com/validate-token?token=${token}`)
	    .then(response => response.json())
	    .then(data => {
	        if (data.valid) {
	            console.log(data.valid);
	             // Decodifica el token para obtener el payload
                     const decodedToken = decodeJwtResponse(token);
         	     const recipeId = decodedToken._id; // Aseg√∫rate de usar el nombre correcto del campo en el payload
                     console.log('Recipe ID:', recipeId);
		     // Almacenar recipeId en local storage
                     localStorage.setItem('recipeId', recipeId);
	             // Llama a la funci√≥n de prueba
	             test_cases_scenario();
	        } else {
	            console.log(data.valid);
	            document.body.innerHTML = 'Access denied. Invalid token.';
	        }
	    }).catch(error => {
	        document.body.innerHTML = 'Error validating token.';
	        console.error('Error:', error);
	    });
    } else {
	    document.body.innerHTML = 'Access denied. No token provided.';
    }
    function test_cases_scenario(){	
	
	const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
		lineNumbers: true,
        mode: 'javascript',
        lineWrapping: true,
        scrollbarStyle: 'null'
	});

	var modal_click_message = "To make the function correctly display 0,1,2 instead of 3,3,3, you can use let instead of var to declare the variable i...";
	var error_message = 'To make the function correctly display 0,1,2 instead of 3,3,3, you can use let instead of var to declare the variable i. '
			+ 'The let keyword is block-scoped, meaning that each iteration of the loop will have its own copy of the variable i, '
			+ 'while var has a function scope, which makes all iterations share the same variable i.';
	var success_message = `Awesome job! üéâ You've just conquered another JavaScript challenge and leveled up your coding skills. Keep pushing the boundaries and exploring new concepts. The journey of learning never stops, and you're doing great! üöÄüí™`

	function logToConsole(message, color) {
		const consoleElement = document.getElementById('console');
		const messageElement = document.createElement('div');
		messageElement.textContent = message;
		if (color) {
			messageElement.style.color = color;
			messageElement.style.fontWeight = 'bold';
		}
		consoleElement.appendChild(messageElement);
	}

	document.getElementById('run-button').addEventListener('click', function() {
		// Clear previous results
		document.getElementById('console').innerHTML = '';
		document.getElementById('mocha').innerHTML = '';
		mocha.suite.suites = []; // Clear previous test cases

		// Get the user's code from the editor
		const userCode = editor.getValue();

		// Redirect console.log to custom console
		const output = [];
		const originalConsoleLog = console.log;
		logToConsole('Running tests....', '#67e810');
		console.log = function(...args) {
		   const message = args.join(' ');
		   originalConsoleLog.apply(console, args); // Still log to the original console
		   logToConsole(message);
		};

		setTimeout(() => {

		// Evaluate the user's code and capture output
		try {
		    const userFunction = new Function(userCode + '; return shape;');  
                    const shape = userFunction();

		// Define test cases
		const expect = chai.expect;
		describe('JavaScript Code Tests', function() {
			it('should execute without errors', function(done) {
				try {
					new Function(userCode)();
					done();
				} catch (e) {
					done(e);
				}
			});

const { expect } = chai;

const shape = {
  out1() {
    let output = [];
    for (let i = 0; i < 3; i++) {
      console.log(i);
      output.push(i);
    }
    return output;
  },
};

// Suite de pruebas
describe('shape.out1()', function() {
  let loggedValues;
  let originalConsoleLog;

  beforeEach(function() {
    // Almacenar la funci√≥n original de console.log y los valores registrados
    loggedValues = [];
    originalConsoleLog = console.log;
    console.log = (...args) => {
      loggedValues.push(args[0]); // Captura el valor registrado
      originalConsoleLog.apply(console, args); // Llama al original console.log
    };
  });

  afterEach(function() {
    // Restaura console.log despu√©s de cada prueba
    console.log = originalConsoleLog;
  });

	
  it('should return an array with values [0, 1, 2]', function() {
    const result = shape.out1();
    expect(result).to.deep.equal([0, 1, 2]); // Este test fallar√°
  });

  it('should log the values 0, 1, and 2 in order', function() {
    // Capturamos los valores loggeados
    const loggedValues = [];
    const originalLog = console.log;
    console.log = (msg) => loggedValues.push(msg);

    shape.out1();

    expect(loggedValues).to.deep.equal([0, 1, 2]); // Este test tambi√©n fallar√°

    // Restauramos console.log
    console.log = originalLog;
  });

	
	
});



			it('should identify falsy values', function() {
				expect(false).to.not.be.ok;
				expect(0).to.not.be.ok;
				expect('').to.not.be.ok;
				expect(null).to.not.be.ok;
				expect(undefined).to.not.be.ok;
				expect(NaN).to.not.be.ok;
			});

			it('should define variables correctly', function() {
				let testVar = 123;
				expect(testVar).to.equal(123);
			});

			it('should define and call functions correctly', function() {
				function testFunction() {
					return 'Hello, World!';
				}
				expect(testFunction()).to.equal('Hello, World!');
			});
		});

		// Variable para rastrear el estado de los tests
		let allTestsPassed = true;
		// Run Mocha tests
		mocha.run()
			.on('test', function(test) {
				logToConsole('‚Ä¢ Running test: ' + test.title);
			})
			.on('test end', function(test) {
				logToConsole('‚Ä¢ Test finished: ' + test.title);
			})
			.on('pass', function(test) {
				logToConsole('‚Ä¢ Test passed: ' + test.title);
			})
			.on('fail', function(test, err) {
				logToConsole('‚Ä¢ Test failed: ' + test.title + ' - ' + err.message);
				success_message = modal_click_message;
				const runButton = document.getElementById('run-button');
				runButton.innerText = 'Reintentar';
				runButton.style.backgroundColor = '#ff0000ad';
				runButton.onclick = function() {
					window.location.reload();
				};
				// Funci√≥n para mostrar el modal con el mensaje de error
				document.getElementById('modify-message').addEventListener('click', function() {
					$('#errorMessageModalBody').html(error_message); // Coloca el contenido del error en el cuerpo del modal
					$('#errorMessageModal').modal('show'); // Muestra el modal
				});
				allTestsPassed = false; // Si cualquier test falla, actualizamos la variable
			})
			.on('end', function() {
				logToConsole('‚Ä¢ All tests finished!');
				document.getElementById('modify-message').innerText = success_message;
				document.getElementById('modify-message').style.display = 'block';
				document.getElementById('modify-message').style.color = 'black';
				if (allTestsPassed) {
				   const sendResponseButton = document.getElementById('send-response-button');
				   sendResponseButton.classList.add('enabled');
				} 
			});
			
			} catch (e) {
			console.error('Error evaluating user code:', e);
			logToConsole('Error: ' + e.message, 'red');
			} finally {
				// Restore original console.log
				console.log = originalConsoleLog;
			}
			
			}, 3000); // 3 seconds delay
	});
    }
    async function guardarResultados() {
	    const formData = JSON.parse(localStorage.getItem("formData"));
	    const email = formData ? formData.Email : null;
            const recipeId = localStorage.getItem('recipeId'); // Recuperar recipeId de local storage
	    // Crear el objeto que se guardar√° en la base de datos
	    // Obtener la URL actual
	    const currentUrl = window.location.href;
	    // Crear un objeto URL
	    const url = new URL(currentUrl);
	    // Eliminar el par√°metro 'token' de la query string
	    url.searchParams.delete('token');
	    // Obtener el pathname sin el token
            const urlWithoutToken = url.pathname.split('/').pop();
	    const recipeCalificadaOk = {
	        recipeId: recipeId,
		url: urlWithoutToken,
	        date: new Date().toISOString()
	    };
	    try {
	        const response = await fetch('https://www.refactorii.com/updateOneGoogleSigninUserRecipe', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json'
	            },
	            //body: JSON.stringify({ Email: email, recipeCalificadaOk: recipeId })
		    body: JSON.stringify({ Email: email, recipeCalificadaOk })	
	        });
	        const data = await response.json();
	        console.log('Server responds:', "Ok");
		// Redirecci√≥n a la p√°gina original
                window.location.href = `https://www.refactorii.com/recipes/${recipeId}`;
	    } catch (error) {
	        console.error('Error sending the results to the server:', error);
	    }
    }

    function decodeJwtResponse(token) {
	    var base64Url = token.split('.')[1];
	    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
	    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
	        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
	    }).join(''));
	    return JSON.parse(jsonPayload);
    }
</script>
</body>
</html>
