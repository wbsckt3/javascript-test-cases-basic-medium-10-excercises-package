<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue.js Test Cases with Mocha and Chai</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>  
    <link rel="stylesheet" href="https://wbsckt3.github.io/mocha_test_cases_styles_2/style.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuex@3.6.2/dist/vuex.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.4/chai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Bootstrap JS y dependencias -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
    <div id="editor-container">
        <textarea id="code-editor">
const shape = {
  out1() {
	return this.name;
  },
  out2() {
	return this.age;
  },
  name: 'Refactorii',
  age: 21,
};
// Casos de prueba:
console.log(shape.out1());
console.log(shape.out2());
        </textarea>
		<img id="logo" src="logo_refactorii.png" alt="Logo Refactorii">
        <button id="run-button">Run</button>
    </div>
    <div id="app-container">
        <div id="app">
		    <h5>Ejercicio 1</h5>
            <p>modifica la función para impimir en consola: <strong>Refactorii, 21</strong></p>
            <div id="modify-message"></div>
			<button id="send-response-button">Enviar respuesta</button>
        </div>
    </div>
    <div id="console-container"><div id="console"></div></div>
    <div id="mocha-container"><div id="mocha"></div></div>
    <script>mocha.setup('bdd');</script>

    <!-- Modal -->
    <div class="modal fade" id="errorMessageModal" tabindex="-1" role="dialog" aria-labelledby="errorMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorMessageModalLabel">Error Message</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="errorMessageModalBody">
                    <!-- Contenido del mensaje de error -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Initialize CodeMirror -->
    <script>
        const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            lineNumbers: true,
            mode: 'javascript',
            lineWrapping: true,
            scrollbarStyle: 'null'
        });
        
        var modal_click_message = `Error, Haz click para entender el concepto, completa el código para imprimir correctamente los valores esperados`;
        var error_message = `Error: AssertionError: expected undefined to equal 'Refactorii' Analiza las funciónes de salida out(). Tip: Falta algo en la sintaxis de la función`;       
		var success_message = `Ok! haz modificado la función para mostrar correctamente los mensajes en consola`
        
        // Función para mostrar el modal con el mensaje de error
        document.getElementById('modify-message').addEventListener('click', function() {
            $('#errorMessageModalBody').html(error_message); // Coloca el contenido del error en el cuerpo del modal
            $('#errorMessageModal').modal('show'); // Muestra el modal
        });

        function logToConsole(message, color) {
            const consoleElement = document.getElementById('console');
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            if (color) {
                messageElement.style.color = color;
                messageElement.style.fontWeight = 'bold';
            }
            consoleElement.appendChild(messageElement);
        }

        document.getElementById('run-button').addEventListener('click', function() {
            // Clear previous results
            document.getElementById('console').innerHTML = '';
            document.getElementById('mocha').innerHTML = '';
            mocha.suite.suites = []; // Clear previous test cases
			
            // Get the user's code from the editor
            const userCode = editor.getValue();

            // Redirect console.log to custom console
			const output = [];
			const originalConsoleLog = console.log;
			console.log = function(message) {
				output.push(message);
				logToConsole(message);
			};
			
			// Show "Ejecutando tests..." message and delay tests
			logToConsole('Ejecutando tests...', 'blue');

			setTimeout(() => {

            // Evaluate the user's code
            try {
                new Function(userCode)();

                // Define test cases
                const expect = chai.expect;
                describe('JavaScript Code Tests', function() {
                    it('should execute without errors', function(done) {
                        try {
                            new Function(userCode)();
                            done();
                        } catch (e) {
                            done(e);
                        }
                    });

                    it('should log correct values', function(done) {
					    const output = [];
						const originalConsoleLog = console.log;
						console.log = function(message) {
							output.push(message);
							originalConsoleLog.apply(console, arguments);
						};
						// Ensure output is clear before each run
						output.length = 0;
						// Execute user code
						new Function(userCode)();
						setTimeout(() => {
						  try {
							// Los logs se almacenan en la variable output durante las llamadas a out1() y out2()
							expect(output[0]).to.equal('Refactorii'); // Verifica el primer log
							expect(output[1]).to.equal(21); // Verifica el segundo log
							done();
						  } catch (err) {
							done(err);
						  }
						}, 10); // Asegúrate de esperar lo suficiente para que se completen las operaciones
					  });

                    it('should identify falsy values', function() {
                        expect(false).to.not.be.ok;
                        expect(0).to.not.be.ok;
                        expect('').to.not.be.ok;
                        expect(null).to.not.be.ok;
                        expect(undefined).to.not.be.ok;
                        expect(NaN).to.not.be.ok;
                    });

                    it('should define variables correctly', function() {
                        let testVar = 123;
                        expect(testVar).to.equal(123);
                    });

                    it('should define and call functions correctly', function() {
                        function testFunction() {
                            return 'Hello, World!';
                        }
                        expect(testFunction()).to.equal('Hello, World!');
                    });
                });

                // Run Mocha tests
                mocha.run()
                    .on('test', function(test) {
                        logToConsole('• Running test: ' + test.title);
                    })
                    .on('test end', function(test) {
                        logToConsole('• Test finished: ' + test.title);
                    })
                    .on('pass', function(test) {
                        logToConsole('• Test passed: ' + test.title);
                    })
                    .on('fail', function(test, err) {
						logToConsole('• Test failed: ' + test.title + ' - ' + err.message);
						success_message = modal_click_message;
						const runButton = document.getElementById('run-button');
						runButton.innerText = 'Reintentar';
						runButton.style.backgroundColor = '#ff0000ad';
						runButton.onclick = function() {
							window.location.reload();
						};
					})
					.on('end', function() {
						logToConsole('• All tests finished!');
						document.getElementById('modify-message').innerText = success_message;
						document.getElementById('modify-message').style.display = 'block';
						document.getElementById('modify-message').style.color = 'black';
						if (success_message === "Ok! haz modificado la función para mostrar correctamente los mensajes en consola") {
							document.getElementById('send-response-button').style.display = 'inline-block';
							document.getElementById('send-response-button').style.background = 'green';
							document.getElementById('send-response-button').style.cursor= 'pointer';
							document.getElementById('send-response-button').style.color= 'white';
						}
					});

            } catch (e) {
                console.error('Error evaluating user code:', e);
                logToConsole('Error: ' + e.message, 'red');
            } finally {
                // Restore original console.log
                console.log = originalConsoleLog;
            }
			
			}, 3000); // 3 seconds delay
			
        });
    </script>
</body>
</html>
